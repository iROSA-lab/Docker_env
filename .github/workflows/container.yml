# This workflow will build a new container image and push it to Docker Hub
# whenever a new commit is pushed to the repository.
on: push
# The jobs section of the workflow file contains a list of jobs.
jobs:
  build-container:
    name: Build & publish robot images
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # the combination of robots and dockerfiles to build
    strategy:
      matrix:
        include:
          - robot: tiago_nvidia
            file: Docker_tiago/Dockerfile_nvidia
          - robot: tiago_no_gpu
            file: Docker_tiago/Dockerfile_no_GPU
          - robot: franka
            file: Docker_franka/Dockerfile_nvidia
          - robot: franka_no_gpu
            file: Docker_franka/Dockerfile_no_GPU
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Source checkout
        uses: actions/checkout@v2.3.4 
      # Setup QEMU
      - name: Setup QEMU
        id: qemu
        uses: docker/setup-qemu-action@v1.2.0
      # Setup Buildx
      - name: Setup Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          version: v0.6.0-rc1
          driver-opts: image=moby/buildkit:master
          buildkitd-flags: --debug

      # logs into docker hub
      - name: login to docker hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      # build and push the container
      - name: build and publish
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: pearlrobots/${{ matrix.robot }}:latest
          labels: pearlrobots/${{ matrix.robot }}:latest
          file: ${{ matrix.file }}
          cache-from: type=gha
          cache-to: type=gha